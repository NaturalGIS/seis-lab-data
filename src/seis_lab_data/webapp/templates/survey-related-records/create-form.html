{% import "macros.html" as macros %}
<form data-on:datastar-fetch="evt.detail.type === 'finished' && document.querySelector('bbox-map')?.initMap()">
    {{ macros.render_localizable_field(form.name) }}
    {{ macros.render_localizable_field(form.description) }}
    {{ macros.render_form_field(form.relative_path) }}
    {{ macros.render_form_field(form.dataset_category_id) }}
    {{ macros.render_form_field(form.domain_type_id) }}
    {{ macros.render_form_field(form.workflow_stage_id) }}

    <div
            class="row"
            data-signals:bbox.min-lon="{{ form.bounding_box.min_lon | int }}"
            data-signals:bbox.max-lon="{{ form.bounding_box.max_lon | int }}"
            data-signals:bbox.min-lat="{{ form.bounding_box.min_lat | int }}"
            data-signals:bbox.max-lat="{{ form.bounding_box.max_lat | int }}"
    >
        <div class="col">
            <h3>{{ _('spatial extent') }}</h3>
            <bbox-map
                    data-tile-url="{{ settings.webmap_base_tile_layer_url }}"
                    data-center-lon="{{ settings.webmap_default_center_lon }}"
                    data-center-lat="{{ settings.webmap_default_center_lat }}"
                    data-zoom="{{ settings.webmap_default_zoom_level }}"
                    data-min-lat=""
                    data-min-lon=""
                    data-max-lat=""
                    data-max-lon=""
                    data-attr:data-min-lat="$bbox.minLat"
                    data-attr:data-min-lon="$bbox.minLon"
                    data-attr:data-max-lat="$bbox.maxLat"
                    data-attr:data-max-lon="$bbox.maxLon"
                    style="display: block; width: 100%; height: 30vh"
                    data-on:bbox-changed="$bbox = evt.detail.bbox"
            ></bbox-map>
        </div>
    </div>
    {{ macros.render_form_field(form.bounding_box.min_lon, data_bind="bbox.minLon") }}
    {{ macros.render_form_field(form.bounding_box.max_lon, data_bind="bbox.maxLon") }}
    {{ macros.render_form_field(form.bounding_box.min_lat, data_bind="bbox.minLat") }}
    {{ macros.render_form_field(form.bounding_box.max_lat, data_bind="bbox.maxLat") }}

    <h3>{{ _("links") | capitalize }}</h3>
    {{ macros.render_links_fields(
        form.links,
        url_for("survey_related_records:add_form_link", survey_mission_id=survey_mission_id),
        url_for("survey_related_records:remove_form_link", survey_mission_id=survey_mission_id),
        form.csrf_token.current_token
    ) }}

    <h3>{{ _("assets") | capitalize }}</h3>
    <div class="row border p-4 mb-3">
        <div id="form-assets-container" class="col">
            {% for asset in form.assets %}
                <h4>{{ _("asset") | capitalize }} {{ loop.index0 + 1 }}</h4>
                {{ macros.render_form_field(asset.asset_id, "asset-") }}
                {{ macros.render_localizable_field(asset.asset_name, "asset-") }}
                {{ macros.render_localizable_field(asset.asset_description, "asset-") }}
                {{ macros.render_form_field(asset.relative_path, "asset-") }}
                <h5>{{ _("asset links") | capitalize }}</h5>
                {{ macros.render_links_fields(
                    asset.asset_links,
                    url_for("survey_related_records:add_asset_link_form", survey_mission_id=survey_mission_id, asset_index=loop.index0),
                    url_for("survey_related_records:remove_asset_link_form", survey_mission_id=survey_mission_id, asset_index=loop.index0),
                    form.csrf_token.current_token,
                    "asset-" ~ loop.index0 ~ "-"
                ) }}

                <button
                        type="submit"
                        class="btn btn-outline-danger"
                        data-on:click="@post('{{ url_for("survey_related_records:remove_asset_form", survey_mission_id=survey_mission_id) }}?asset_index={{ loop.index0 }}', {
                  contentType: 'form',
                  headers: {'X-CSRFToken': '{{ form.csrf_token.current_token }}'},
                })"
                >{{ _("remove asset") | capitalize }}</button>
            {% endfor %}
        </div>
        <div class="row">
            <div class="col">
                <button
                        type="button"
                        class="btn btn-outline-secondary"
                        aria-label="add-another-asset"
                        data-on:click="@post('{{ url_for("survey_related_records:add_asset_form", survey_mission_id=survey_mission_id) }}', {
          contentType: 'form',
          headers: {'X-CSRFToken': '{{ form.csrf_token.current_token }}'},
        })"
                >
                    {{ _("add another asset") | capitalize }}
                </button>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-sm-10 offset-sm-2">
            <button
                    type="submit"
                    aria-label="submit-create-form"
                    class="btn btn-primary"
                    data-on:click="@post('{{ url_for('survey_missions:detail', survey_mission_id=survey_mission_id) }}', {
                            contentType: 'form',
                            headers: {'X-CSRFToken': '{{ form.csrf_token.current_token }}'}
                        })"
                    data-indicator="posting"
                    data-attr:disabled="$posting"
                    data-text="$posting ? '{{ _('Creating survey record...') }}' : '{{ _('Create survey record') }}'"
            >
            </button>
            <div class="spinner-border spinner-border-sm ms-3" role="status" aria-hidden="true"
                 data-attr:hidden="!$posting">
                <span class="visually-hidden">{{ _("Loading...") }}</span>
            </div>
        </div>
    </div>
</form>
