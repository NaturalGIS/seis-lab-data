{#
This template is loaded as a GET response to the /projects/ endpoint. It is used to both:

- Show a list of existing projects
- Show a form for creating a new project (if the user has permissions to do so), when the user clicks the project
  creation button - this is loaded via a server-sent event and patched into the already existing DOM, replacing the
  list of projects
#}
{% extends "base.html" %}
{% import "macros.html" as macros %}
{% import "macros-buttons-list-items.html" as macros_buttons_list_items %}

{% block head %}
    {{ super() }}
    <script type="module" src="{{ url_for('static', path='/js/maplibre-gl-v5.9.0.js') }}"></script>
    <link href="{{ url_for('static', path='/css/maplibre-gl-v5.9.0.css') }}" rel='stylesheet'/>
    <script type="module" src="{{ url_for('static', path='/js/terra-draw-v1.0.0.umd.js') }}"></script>
    <script type="module"
            src="{{ url_for('static', path='/js/terra-draw-maplibre-gl-adapter-v1.0.0.umd.js') }}"></script>
    <script type="module" src="{{ url_for('static', path='/js/bbox-map.js') }}"></script>
    <script type="module" src="{{ url_for('static', path='/js/map-with-layer.js') }}"></script>
    <script type="module" src="{{ url_for('static', path='/js/basemap.js') }}"></script>
{% endblock head %}

{% block page_title %}
    <span class="material-icons-outlined">view_timeline</span>{{ _("Projects") }}
{% endblock page_title %}

{% block details %}
    <script>
        window.iconNames = JSON.parse('{{ icons | tojson }}')
    </script>

    <div class="row">
        <div class="col">
            <div
                    class="row justify-content-center m-5"
                    data-signals:search='{{ search_initial_value }}'
                    data-signals:advanced-search-panel-open="false"
                    data-signals:searching="false"
            >
                <div class="col-8">
                    <search class="form-floating">
                        <input
                                class="form-control form-control-lg"
                                type="search"
                                id="search"
                                placeholder="Search"
                                data-bind:search
                                data-on:input__debounce.200ms="@get('{{ url_for("projects:get_list_component") }}')"
                                data-indicator:searching
                        />
                        <label class="form-label" for="search">
                            <span class="material-icons-outlined">{{ icons.search }}</span>
                            {{ _("search projects") | capitalize }}
                        </label>
                    </search>
                    <div
                            data-attr:hidden="!$searching"
                            class="spinner-border spinner-border-sm ms-3"
                            role="status"
                            aria-hidden="true"
                    >
                        <span class="visually-hidden">{{ _("searching...") | capitalize }}</span>
                    </div>
                    <button
                            class="btn btn-light btn-sm mt-1"
                            type="button"
                            data-on:click="$advancedSearchPanelOpen=!$advancedSearchPanelOpen"
                            data-bs-toggle="collapse"
                            data-bs-target="#advanced-search-controls"
                            aria-expanded="false"
                            aria-controls="advanced-search-controls"
                    >
                        <span
                                class="material-icons-outlined me-1"
                                data-attr:style="$advancedSearchPanelOpen ? 'transform: rotate(0deg); transition: transform 0.3s ease;' : 'transform: rotate(-90deg); transition: transform 0.3s ease;'"
                        >
                            {{ icons.expand_more }}
                        </span>
                        {{ _("toggle advanced search controls") | capitalize }}
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col mt-1 mb-5">
                    <div class="row collapse" id="advanced-search-controls">
                        <div class="col-4">
                            {{ macros.render_temporal_extent_search_component(
                                url_for("projects:get_list_component"),
                                _("Temporal extent begin"),
                                _("Temporal extent end"),
                                "{{ current_temporal_extent.begin }}",
                                "{{ current_temporal_extent.end }}"
                            ) }}
                        </div>
                        <div
                                class="col"
                                data-signals:current-bbox="null"
                                data-computed:min-lon="$currentBbox?.[0]?.[0]"
                                data-computed:min-lat="$currentBbox?.[0]?.[1]"
                                data-computed:max-lon="$currentBbox?.[1]?.[0]"
                                data-computed:max-lat="$currentBbox?.[1]?.[1]"
                        >
                            <base-map
                                    data-base-map-tile-url="{{ settings.webmap_base_tile_layer_url }}"
                                    data-polygon-features="{{ geojson_features }}"
                                    data-polygon-fill-color="{{ settings.webmap_default_polygon_fill_color }}"
                                    data-polygon-fill-opacity="{{ settings.webmap_default_polygon_fill_opacity }}"
                                    data-polygon-outline-color="{{ settings.webmap_default_polygon_outline_color }}"
                                    data-polygon-outline-opacity="{{ settings.webmap_default_polygon_outline_opacity }}"
                                    data-polygon-outline-width="{{ settings.webmap_default_polygon_outline_width }}"
                                    data-item-detail-base-url="{{ map_popup_detail_base_url | default('') }}"
                                    data-initial-min-lon="{{ map_bounds.min_lon }}"
                                    data-initial-min-lat="{{ map_bounds.min_lat }}"
                                    data-initial-max-lon="{{ map_bounds.max_lon }}"
                                    data-initial-max-lat="{{ map_bounds.max_lat }}"
                                    style="display: block; width: 100%; height: 30vh"
                                    data-on:map-moveend="document.querySelector('base-map').checkVisibility() ? $currentBbox=evt.detail.map.getBounds().toArray() : $currentBbox=[[-180, -90],[180, 90]]; @get('{{ url_for('projects:get_list_component') }}')"

                            ></base-map>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-9">
            {% include "projects/list-component.html" %}
        </div>
        <div class="col-3">
            <h5>{{ _("actions") | capitalize }}</h5>
            <div class="list-group mb-3">
                {% if user_can_create %}
                    {{ macros_buttons_list_items.render_new_item_button(
                        url_for("projects:get_creation_form"), _("Add new project"), colorize_with="info", aria_label="new-project"
                    ) }}
                {% endif %}
            </div>
            <h5>{{ _("info") | capitalize }}</h5>
            <ul class="list-group">
                <li class="list-group-item">
                    <p>{{ _("Projects with a status of DRAFT are only visible to their owners") }}</p>
                    <p>{{ _("In order to become viewable by all users, a project must be published. Publication is only possible once the project is considered valid.") }}</p>
                    <p>{{ _("Valid projects can be published. When published, a project becomes visible for all users") }}</p>
                </li>
            </ul>
        </div>
    </div>
{% endblock details %}
