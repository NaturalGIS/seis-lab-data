when:
  - event: deployment
    evaluate: 'CI_PIPELINE_DEPLOY_TARGET == "naturalgis-test" || CI_PIPELINE_DEPLOY_TARGET == "ipma-production"'

steps:
  - name: extract-deployment-payload
    image: leplusorg/json:sha-0b8b943
    commands: |
      DEPLOYMENT_JSON=$(curl --silent "${CI_PIPELINE_FORGE_URL}")
      IMAGE_URL=$(echo "$${DEPLOYMENT_JSON}" | jq --raw-output '.payload.image_url')

      if [ "$${IMAGE_URL}" = "null" ]; then
        echo "Image URL not found in the deployment payload, skipping..."
        echo "SKIP_DEPLOYMENT=true" >> envvars
        exit 0
      fi

      echo "IMAGE_URL=$${IMAGE_URL}" > envvars

  - name: deploy-to-test-env
    when:
      - evaluate: 'CI_PIPELINE_DEPLOY_TARGET == "naturalgis-test"'
    image: docker:24-cli
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /opt/seis-lab-data:/opt/seis-lab-data
    environment:
      GITHUB_USER: {from_secret: github_user}
      GITHUB_PAT: {from_secret: github_pat}
    commands: |
      . envvars

      if [ "$${SKIP_DEPLOYMENT}" = "true" ]; then
        echo "Skipping deployment"
        exit 0
      fi

      export IMAGE_URL=$${IMAGE_URL}
      DEPLOYMENT_DIR="/opt/seis-lab-data"
      # Get target user/group from host directory - assumes directory already owned by correct user
      TARGET_UID=$(stat -c '%u' $${DEPLOYMENT_DIR})
      TARGET_GID=$(stat -c '%g' $${DEPLOYMENT_DIR})
      echo "Target directory ownership: UID=$TARGET_UID, GID=$TARGET_GID"

      # Files to copy from the cloned repo
      COMPOSE_FILE_NAME="compose.test-env.yaml"
      AUTHENTIK_BLUEPRINT_FILE_NAME="sld-auth-blueprint-test-env.yaml"

      echo "Copying files to host"
      cp docker/$${COMPOSE_FILE_NAME} $${DEPLOYMENT_DIR}
      chown $${TARGET_UID}:$${TARGET_GID} $${DEPLOYMENT_DIR}/$${COMPOSE_FILE_NAME}
      mkdir -p $${DEPLOYMENT_DIR}/authentik
      chown $${TARGET_UID}:$${TARGET_GID} $${DEPLOYMENT_DIR}/authentik
      cp docker/authentik/$${AUTHENTIK_BLUEPRINT_FILE_NAME} $${DEPLOYMENT_DIR}/authentik
      chown $${TARGET_UID}:$${TARGET_GID} $${DEPLOYMENT_DIR}/authentik/$${AUTHENTIK_BLUEPRINT_FILE_NAME}

      ENV_FILE_NAME="compose-deployment.env"

      if [ ! -f $${DEPLOYMENT_DIR}/$${ENV_FILE_NAME} ]; then
        echo "ERROR: env file not found at $${DEPLOYMENT_DIR}/$${ENV_FILE_NAME}"
        echo "Please ensure the environment file is present on the host"
        exit 1
      fi

      cd $${DEPLOYMENT_DIR}
      echo "Files in deployment directory:"
      ls -la

      echo "Logging in to docker registry"
      echo $${GITHUB_PAT} | docker login ghcr.io --username $${GITHUB_USER} --password-stdin

      echo "Pulling latest image: $${IMAGE_URL}"
      docker pull $${IMAGE_URL}

      echo "Stopping existing containers..."
      docker compose \
        --env-file $${ENV_FILE_NAME} \
        --file $${COMPOSE_FILE_NAME} \
        down || true

      echo "Starting deployment..."
      docker compose \
        --env-file $${ENV_FILE_NAME} \
        --file $${COMPOSE_FILE_NAME} \
        up --wait --wait-timeout 300

      echo "Applying database migrations..."
      docker compose \
        --env-file $${ENV_FILE_NAME} \
        --file $${COMPOSE_FILE_NAME} \
        exec -T webapp uv run seis-lab-data db upgrade

      docker logout ghcr.io

  - name: deploy-to-production-env
    when:
      - evaluate: 'CI_PIPELINE_DEPLOY_TARGET == "ipma-production"'
    image: alpine:3.19
    environment:
      SSH_USER: {from_secret: prod_ssh_user}
      SSH_KEY: {from_secret: prod_ssh_key}
      GITHUB_USER: {from_secret: github_user}
      GITHUB_PAT: {from_secret: github_pat}
    commands: |
      . envvars

      if [ "$${SKIP_DEPLOYMENT}" = "true" ]; then
        echo "Skipping deployment"
        exit 0
      fi

      apk add --no-cache openssh-client

      # Setup SSH
      mkdir -p ~/.ssh
      echo "$${SSH_KEY}" > ~/.ssh/id_rsa
      chmod 600 ~/.ssh/id_rsa
      ssh-keyscan -H 193.137.20.17 >> ~/.ssh/known_hosts 2>/dev/null

      REMOTE_HOST="193.137.20.17"
      REMOTE_DIR="/opt/seis-lab-data"

      # Copy files to remote server
      scp docker/compose.prod-env.yaml "$${SSH_USER}@$${REMOTE_HOST}:$${REMOTE_DIR}/"
      scp docker/authentik/sld-auth-blueprint-prod-env.yaml "$${SSH_USER}@$${REMOTE_HOST}:$${REMOTE_DIR}/"
      scp docker/caddy/Caddyfile "$${SSH_USER}@$${REMOTE_HOST}:$${REMOTE_DIR}/"
      scp docker/traefik/traefik-prod-config.toml "$${SSH_USER}@$${REMOTE_HOST}:$${REMOTE_DIR}/"

      # Run deployment on remote server
      ssh "$${SSH_USER}@$${REMOTE_HOST}" GITHUB_USER="$${GITHUB_USER}" GITHUB_PAT="$${GITHUB_PAT}" IMAGE_URL="$${IMAGE_URL}" bash -s << 'ENDSSH' || exit 1
        set -e
        DEPLOYMENT_DIR="/opt/seis-lab-data"
        cd "$DEPLOYMENT_DIR"

        echo "$GITHUB_PAT" | docker login ghcr.io --username "$GITHUB_USER" --password-stdin

        echo "Deploying with Image -> $IMAGE_URL"
        docker pull "$IMAGE_URL"

        echo "IMAGE_URL=$IMAGE_URL" > image_url.env

        docker compose \
          -f compose.prod-env.yaml \
          --env-file compose-deployment.env \
          --env-file image_url.env \
          --progress quiet \
          up --remove-orphans --wait --wait-timeout 300

        echo "Running database migrations..."
        docker compose \
          -f compose.prod-env.yaml \
          --env-file compose-deployment.env \
          --env-file image_url.env \
          exec -T webapp uv run seis-lab-data db upgrade

        docker logout ghcr.io
      ENDSSH

  # NOTE: this below section is for notifications. This implementation is a bit convoluted, having a step for
  # sending success notification and another for sending failure. This was done like this because woodpecker
  # does not currently have any env variable that contains the status of a pipeline, as per:
  #
  # https://github.com/woodpecker-ci/woodpecker/issues/4337
  #
  - name: notify success
    image: appleboy/drone-telegram:1.4.0
    environment:
      PLUGIN_TOKEN: {from_secret: telegram_bot_token}
      PLUGIN_TO: {from_secret: telegram_chat_id}
    commands: |
      . envvars

      if [ "$${SKIP_DEPLOYMENT}" = "true" ]; then
          echo "Deployment was skipped, not sending notification"
          exit 0
      fi

      export PLUGIN_MESSAGE="✅ $${CI_PIPELINE_DEPLOY_TARGET} | Deployment successful | $${CI_PIPELINE_URL}"
      /bin/drone-telegram

    when:
      - status: [success]

  - name: notify failure
    image: appleboy/drone-telegram:1.4.0
    environment:
      PLUGIN_TOKEN: {from_secret: telegram_bot_token}
      PLUGIN_TO: {from_secret: telegram_chat_id}
    commands: |
      . envvars

      if [ "$${SKIP_DEPLOYMENT}" = "true" ]; then
          echo "Deployment was skipped, not sending notification"
          exit 0
      fi

      export PLUGIN_MESSAGE="❌ $${CI_PIPELINE_DEPLOY_TARGET} | Deployment failed | $${CI_PIPELINE_URL}"
      /bin/drone-telegram

    when:
      - status: [failure]
